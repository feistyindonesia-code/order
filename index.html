<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feisty Order</title><!-- Tailwind (boleh untuk GitHub Pages) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      font-family: Arimo, Arial, sans-serif;
      background: linear-gradient(135deg, #fff8f0 0%, #ffe8d6 100%);
    }

    html, body {
      height: 100%;
      width: 100%;
    }

    #app-wrapper {
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #FF4500;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div id="app-wrapper">
   <header class="bg-gradient-to-r from-orange-600 to-red-600 p-4 text-center shadow-lg"><img src="https://imgur.com/E9ya4d5.png" alt="Feisty" class="mx-auto h-16" onerror="this.style.display='none'">
   </header>
   <main class="flex-1 p-4 overflow-y-auto">
    <div id="menu-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
     <div class="text-center col-span-full text-gray-600">
      Memuat menu...
     </div>
    </div>
   </main><!-- CART -->
   <div id="cart-section" class="fixed bottom-0 left-0 right-0 bg-white shadow-2xl rounded-t-xl translate-y-full transition-transform max-h-96 overflow-y-auto">
    <div class="p-4 font-bold flex justify-between sticky top-0 bg-white border-b">
     Keranjang <button onclick="toggleCart(false)">✕</button>
    </div>
    <div id="cart-items" class="px-4 text-sm text-gray-500">
     Keranjang kosong
    </div>
    <div id="cart-summary" class="p-4 hidden border-t-2 border-orange-600 bg-white sticky bottom-0">
     <div class="flex justify-between mb-2"><span>Subtotal</span> <span id="subtotal">Rp 0</span>
     </div>
     <div class="flex justify-between mb-3"><span>Ongkir</span> <span id="shipping-cost">Rp 0</span>
     </div>
     <div class="flex justify-between font-bold text-lg text-orange-600 mb-3"><span>Total</span> <span id="total">Rp 0</span>
     </div><button id="checkout-btn" class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white py-3 rounded-lg font-bold hover:shadow-lg transition"> Checkout </button>
    </div>
   </div>
  </div>
  <script>
/* ================= CONFIG ================= */
const config = {
  gas_url: "https://script.google.com/macros/s/AKfycbz5ZTxm6KytLSwOew7HXxoaiW4fr3j2e_DoH4kwuP-zT_TZAiJJDrncANj6TXq9WypQHQ/exec",
  gas_url_bot: "https://script.google.com/macros/s/AKfycbxMRsrY1qzjcAUdnbDgH0cvvyBN38OMCNLB4KWJ7uInQi0k3BuHLPNLLwJRlXgVdk3C/exec",
  store_latitude: -6.2088,
  store_longitude: 106.8456,
  base_shipping_cost: 10000,
  shipping_cost_per_km: 2000
};

/* ================= STATE ================= */
let menuData = [];
let cartData = {};
let shippingCost = 0;

/* ================= LOAD MENU (JSONP) ================= */
function loadMenu() {
  const script = document.createElement("script");
  script.src = config.gas_url + "?action=getMenu&callback=renderMenu";
  document.body.appendChild(script);
}

/* ================= RENDER MENU ================= */
function renderMenu(response) {

  if (!response || response.length === 0) {
    document.getElementById("menu-list").innerHTML =
      "<div class='col-span-full text-center'>Menu kosong</div>";
    return;
  }

  menuData = response;

  const el = document.getElementById("menu-list");
  el.innerHTML = "";

  menuData.forEach(item => {
    el.innerHTML += `
      <div class="bg-white rounded-xl shadow p-3 hover:shadow-lg transition">
        <img src="${item.gambar || ''}"
             class="h-32 w-full object-cover rounded mb-2"
             onerror="this.style.display='none'">
        <h3 class="font-bold text-sm">${item.nama}</h3>
        <p class="text-xs text-gray-500 mb-2">${item.deskripsi || ''}</p>
        <div class="flex justify-between items-center mt-2">
          <span class="font-bold text-orange-600">
            Rp ${Number(item.harga).toLocaleString('id-ID')}
          </span>
          <button onclick="addToCart('${item.id}','${item.nama}',${item.harga})"
                  class="bg-orange-600 text-white px-2 py-1 rounded text-xs font-semibold hover:bg-orange-700">
            + Pesan
          </button>
        </div>
      </div>
    `;
  });
}

/* ================= CART ================= */
function addToCart(id, name, price) {
  if (!cartData[id]) cartData[id] = { name, price, qty: 0 };
  cartData[id].qty++;
  updateCart();
  toggleCart(true);
}

function updateCart() {
  const items = Object.values(cartData);
  const container = document.getElementById("cart-items");
  const summary = document.getElementById("cart-summary");

  if (items.length === 0) {
    container.innerHTML = '<div class="text-center py-8 text-gray-400">Keranjang kosong</div>';
    summary.classList.add("hidden");
    return;
  }

  let total = 0;
  container.innerHTML = "";

  items.forEach((i, idx) => {
    total += i.price * i.qty;
    const itemTotal = i.price * i.qty;
    container.innerHTML += `
      <div class="flex justify-between items-center py-3 border-b">
        <div class="flex-1">
          <div class="font-semibold text-sm">${i.name}</div>
          <div class="text-xs text-gray-500">Rp ${i.price.toLocaleString('id-ID')} x ${i.qty}</div>
          <div class="text-sm font-bold text-orange-600">Rp ${itemTotal.toLocaleString('id-ID')}</div>
        </div>
        <div class="flex gap-2">
          <button onclick="changeQty('${Object.keys(cartData)[idx]}', -1)" class="px-2 py-1 bg-gray-200 rounded text-xs">−</button>
          <button onclick="changeQty('${Object.keys(cartData)[idx]}', 1)" class="px-2 py-1 bg-gray-200 rounded text-xs">+</button>
        </div>
      </div>
    `;
  });

  document.getElementById("subtotal").textContent = "Rp " + total.toLocaleString("id-ID");
  document.getElementById("shipping-cost").textContent = "Rp " + shippingCost.toLocaleString("id-ID");
  document.getElementById("total").textContent = "Rp " + (total + shippingCost).toLocaleString("id-ID");

  summary.classList.remove("hidden");
}

function changeQty(id, change) {
  if (!cartData[id]) return;
  cartData[id].qty += change;
  if (cartData[id].qty <= 0) {
    delete cartData[id];
  }
  updateCart();
}

function toggleCart(open) {
  document.getElementById("cart-section")
    .style.transform = open ? "translateY(0)" : "translateY(100%)";
}

/* ================= HELPER FUNCTIONS ================= */
function escapeHtml(text) {
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}

function generateOrderId() {
  return 'ORD-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
}

function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function calculateShippingCost(distance) {
  return config.base_shipping_cost + (Math.ceil(distance) * config.shipping_cost_per_km);
}

/* ================= CHECKOUT FORM ================= */
document.getElementById("checkout-btn").onclick = () => {
  const items = Object.values(cartData);
  if (items.length === 0) {
    alert("Keranjang kosong");
    return;
  }
  showCheckoutForm();
};

function showCheckoutForm() {
  const overlay = document.createElement("div");
  overlay.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto";
  
  const modal = document.createElement("div");
  modal.className = "bg-white rounded-lg w-full max-w-md my-8";
  modal.innerHTML = `
    <div class="p-6">
      <h2 class="text-xl font-bold mb-4">Data Pesanan</h2>
      
      <div class="mb-4">
        <label class="block text-sm font-semibold mb-2">Nama Lengkap *</label>
        <input type="text" id="checkout-nama" placeholder="Masukkan nama Anda" 
               class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold mb-2">Nomor WhatsApp *</label>
        <input type="tel" id="checkout-wa" placeholder="08xxxxxxxxxx" 
               class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold mb-2">Alamat Lengkap *</label>
        <textarea id="checkout-alamat" placeholder="Jln. ... No. ..." 
                  class="w-full border rounded px-3 py-2 text-sm h-24 focus:outline-none focus:ring-2 focus:ring-orange-500" style="font-family: Arimo, Arial, sans-serif;"></textarea>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold mb-2">Koordinat (Opsional)</label>
        <input type="text" id="checkout-coords" placeholder="Contoh: -6.2088, 106.8456" 
               class="w-full border rounded px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-orange-500">
        <div id="location-info" class="mt-2 text-xs text-blue-600 bg-blue-50 p-2 rounded">
          Kosongkan jika tidak tahu. Ongkir akan dihitung dari alamat.
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold mb-2">Metode Pembayaran *</label>
        <select id="checkout-metode" class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
          <option value="COD">COD (Bayar di Tempat)</option>
          <option value="QRIS">QRIS</option>
          <option value="TRANSFER">Transfer Bank</option>
        </select>
      </div>

      <div class="flex gap-2">
        <button onclick="submitCheckout()" 
                class="flex-1 bg-orange-600 text-white py-2 rounded font-semibold hover:bg-orange-700 transition">
          Lanjutkan
        </button>
        <button onclick="closeCheckoutForm()" 
                class="flex-1 bg-gray-300 text-gray-800 py-2 rounded font-semibold hover:bg-gray-400 transition">
          Batal
        </button>
      </div>
    </div>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  window.checkoutOverlay = overlay;

  // Handle koordinat input
  document.getElementById("checkout-coords").addEventListener("change", (e) => {
    const coordsText = e.target.value.trim();
    const locationInfo = document.getElementById("location-info");
    
    if (!coordsText) {
      shippingCost = 0;
      locationInfo.innerHTML = "Kosongkan jika tidak tahu. Ongkir akan dihitung dari alamat.";
      locationInfo.style.color = "#2563eb";
      locationInfo.style.background = "#eff6ff";
      return;
    }

    const coords = coordsText.split(",").map(c => parseFloat(c.trim()));
    if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
      const distance = calculateDistance(config.store_latitude, config.store_longitude, coords[0], coords[1]);
      shippingCost = calculateShippingCost(distance);
      locationInfo.innerHTML = `✓ Jarak: ${distance.toFixed(2)} km | Ongkir: Rp ${shippingCost.toLocaleString('id-ID')}`;
      locationInfo.style.color = "#16a34a";
      locationInfo.style.background = "#f0fdf4";
    } else {
      locationInfo.innerHTML = "❌ Format: lat, lon (contoh: -6.2088, 106.8456)";
      locationInfo.style.color = "#dc2626";
      locationInfo.style.background = "#fef2f2";
    }
  });

  setTimeout(() => {
    document.getElementById("checkout-nama").focus();
  }, 100);
}

function closeCheckoutForm() {
  if (window.checkoutOverlay) {
    window.checkoutOverlay.remove();
  }
}

function submitCheckout() {
  const nama = document.getElementById("checkout-nama").value.trim();
  const wa = document.getElementById("checkout-wa").value.trim();
  const alamat = document.getElementById("checkout-alamat").value.trim();
  const metode = document.getElementById("checkout-metode").value;

  const errors = [];
  if (!nama) errors.push("• Nama Lengkap");
  if (!wa) errors.push("• Nomor WhatsApp");
  if (!alamat) errors.push("• Alamat Lengkap");

  if (errors.length > 0) {
    alert("Harap isi:\n" + errors.join("\n"));
    return;
  }

  processOrder(nama, wa, alamat, metode);
}

/* ================= SUBMIT ORDER ================= */
function processOrder(customerName, customerPhone, customerAddress, paymentMethod) {
  if (window.checkoutOverlay) window.checkoutOverlay.remove();

  const loadingOverlay = document.createElement("div");
  loadingOverlay.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
  loadingOverlay.innerHTML = `
    <div class="bg-white rounded-lg p-8 text-center max-w-sm w-full mx-4">
      <div class="spinner mx-auto mb-4"></div>
      <p class="text-gray-700 font-semibold">Memproses pesanan...</p>
    </div>
  `;
  document.body.appendChild(loadingOverlay);

  try {
    const orderId = generateOrderId();
    const items = Object.entries(cartData).map(([_, item]) => ({
      name: item.name,
      price: item.price,
      qty: item.qty
    }));
    const total = Object.values(cartData).reduce((sum, item) => sum + (item.price * item.qty), 0);
    const totalWithShipping = total + shippingCost;

    const orderData = {
      order_id: orderId,
      customer_name: customerName,
      customer_phone: customerPhone,
      customer_address: customerAddress,
      items: items,
      subtotal: total,
      shipping_cost: shippingCost,
      total: totalWithShipping,
      payment_method: paymentMethod,
      timestamp: new Date().toLocaleString("id-ID")
    };

    // Kirim ke GAS
    const formData = new URLSearchParams();
    formData.append("data", JSON.stringify(orderData));

    fetch(config.gas_url_bot, {
      method: "POST",
      body: formData
    })
    .then(() => {
      // Anggap berhasil walau error (GAS offline possible)
      showSuccessModal(orderData);
      cartData = {};
      shippingCost = 0;
      updateCart();
      toggleCart(false);
      loadingOverlay.remove();
    })
    .catch(err => {
      console.error(err);
      // Tetap anggap berhasil
      showSuccessModal(orderData);
      cartData = {};
      shippingCost = 0;
      updateCart();
      toggleCart(false);
      loadingOverlay.remove();
    });

  } catch (error) {
    console.error("Error:", error);
    loadingOverlay.innerHTML = `
      <div class="bg-white rounded-lg p-8 text-center max-w-sm w-full mx-4">
        <div class="text-4xl mb-4">❌</div>
        <p class="text-gray-700 font-semibold mb-4">Gagal memproses pesanan</p>
        <button onclick="this.closest('.fixed').remove()" 
                class="px-4 py-2 bg-orange-600 text-white rounded font-semibold hover:bg-orange-700">
          Tutup
        </button>
      </div>
    `;
  }
}

function showSuccessModal(data) {
  const overlay = document.createElement("div");
  overlay.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto";
  
  const modal = document.createElement("div");
  modal.className = "bg-white rounded-lg max-w-md w-full p-6 text-center my-8";
  modal.innerHTML = `
    <div class="text-5xl mb-3">✅</div>
    <h2 class="text-2xl font-bold mb-2 text-green-600">Pesanan Berhasil!</h2>
    <p class="text-gray-600 mb-4 text-sm">Pesanan Anda sedang diproses</p>
    
    <div class="bg-gray-100 rounded p-4 text-left text-sm mb-4 space-y-2">
      <p><strong>Order ID:</strong> ${data.order_id}</p>
      <p><strong>Nama:</strong> ${escapeHtml(data.customer_name)}</p>
      <p><strong>WhatsApp:</strong> ${data.customer_phone}</p>
      <p><strong>Metode:</strong> ${data.payment_method}</p>
      <p><strong>Total:</strong> <span class="font-bold text-orange-600">Rp ${data.total.toLocaleString('id-ID')}</span></p>
    </div>

    <p class="text-xs text-gray-500 mb-4">Kami akan hubungi Anda via WhatsApp</p>

    <button onclick="this.closest('.fixed').remove()" 
            class="w-full bg-orange-600 text-white py-2 rounded font-semibold hover:bg-orange-700 transition">
      Tutup
    </button>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);
}

/* ================= INIT ================= */
loadMenu();
</script>
 </body>
</html>